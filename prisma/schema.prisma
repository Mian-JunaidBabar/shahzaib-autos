// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ADMIN ACCESS (Maps Supabase users to admins)
// ============================================
// NOTE: Authentication is handled EXCLUSIVELY by Supabase Auth.
// This table only stores Supabase user IDs that have admin access.
// DO NOT store passwords, sessions, or tokens here.

model Admin {
  id              String   @id @default(uuid())
  supabaseUserId  String   @unique @map("supabase_user_id") // Supabase auth.users.id
  createdAt       DateTime @default(now()) @map("created_at")

  profile AdminProfile?

  @@map("admins")
}

// ============================================
// ADMIN PROFILE (Non-auth metadata)
// ============================================
// Stores profile information for admin users.
// DO NOT store passwords, emails, or auth credentials.
// Identity comes from Supabase Auth.

model AdminProfile {
  id           String   @id // Same as admin.supabaseUserId
  adminId      String   @unique @map("admin_id")
  fullName     String?  @map("full_name")
  avatarUrl    String?  @map("avatar_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_profiles")
}

// ============================================
// PRODUCT & INVENTORY
// ============================================

// Product status for stock automation
enum ProductStatus {
  ACTIVE
  OUT_OF_STOCK
  DRAFT
  ARCHIVED
}

model Badge {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "BESTSELLER", "TRENDING", "NEW"
  color     String   // e.g., "bg-blue-500"
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  products Product[]

  @@map("badges")
}

model Product {
  id          String        @id @default(uuid())
  name        String
  slug        String        @unique
  sku         String        @unique // Stock Keeping Unit - critical for auto parts
  description String?       @db.Text
  price       Int           // Selling price in cents
  salePrice   Int?          @map("sale_price") // Discounted price in cents (optional)
  costPrice   Int?          @map("cost_price") // Cost price for margin tracking (optional)
  barcode     String?       // Optional barcode for scanning
  category    String?
  badgeId     String?       @map("badge_id")
  status      ProductStatus @default(ACTIVE)
  isActive    Boolean       @default(true) @map("is_active")
  isArchived  Boolean       @default(false) @map("is_archived") // Soft delete flag
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  badge       Badge?   @relation(fields: [badgeId], references: [id])
  images      Image[]       // Unified Image relation
  inventory   Inventory?
  orderItems  OrderItem[]

  @@map("products")
}

// ============================================
// UNIFIED IMAGE MODEL
// ============================================
// Polymorphic image table for Products and Services.
// Cloudinary public_id stored for guaranteed cleanup.

model Image {
  id        String   @id @default(cuid())
  publicId  String   @unique @map("public_id") // Cloudinary public_id for deletion
  secureUrl String   @map("secure_url")        // Cloudinary secure URL
  isPrimary Boolean  @default(false) @map("is_primary")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  // Polymorphic relations (one of these will be set)
  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  serviceId String?  @map("service_id")
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("images")
}

model Inventory {
  id           String   @id @default(uuid())
  productId    String   @unique @map("product_id")
  quantity     Int      @default(0)
  lowStockAt   Int      @default(10) @map("low_stock_at") // Alert threshold
  reorderPoint Int      @default(5) @map("reorder_point")
  updatedAt    DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("inventory")
}

// ============================================
// ORDERS & ORDER ITEMS
// ============================================

enum OrderStatus {
  NEW
  CONTACTED
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model Order {
  id            String      @id @default(uuid())
  orderNumber   String      @unique @map("order_number")
  customerId    String?     @map("customer_id")
  customerName  String      @map("customer_name")
  customerPhone String      @map("customer_phone")
  customerEmail String?     @map("customer_email")
  address       String?     @db.Text
  subtotal      Int         // In cents
  total         Int         // In cents
  status        OrderStatus @default(NEW)
  notes         String?     @db.Text
  whatsappSent  Boolean     @default(false) @map("whatsapp_sent")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id])
  items    OrderItem[]
  booking  Booking? // One-to-one relation (booking can be linked to an order)

  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  productId String @map("product_id")
  name      String // Snapshot of product name at order time
  price     Int    // Snapshot of price at order time (cents)
  quantity  Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// ============================================
// BOOKINGS (Service Appointments)
// ============================================

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Booking {
  id            String        @id @default(uuid())
  bookingNumber String        @unique @map("booking_number")
  customerId    String?       @map("customer_id")
  customerName  String        @map("customer_name")
  customerPhone String        @map("customer_phone")
  customerEmail String?       @map("customer_email")
  serviceType   String        @map("service_type")
  vehicleInfo   String?       @map("vehicle_info") // Make, model, year
  date          DateTime
  timeSlot      String?       @map("time_slot")
  address       String        @db.Text
  notes         String?       @db.Text
  status        BookingStatus @default(PENDING)
  whatsappSent  Boolean       @default(false) @map("whatsapp_sent")
  orderId       String?       @unique @map("order_id") // Link to order
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  customer      Customer?             @relation(fields: [customerId], references: [id])
  order         Order?                @relation(fields: [orderId], references: [id], onDelete: SetNull)
  activityLog   BookingActivityLog[]

  @@map("bookings")
}

// ============================================
// BOOKING ACTIVITY LOG (Track booking changes)
// ============================================

model BookingActivityLog {
  id        String   @id @default(cuid())
  bookingId String   @map("booking_id")
  activity  String   // e.g., "Status changed to CONFIRMED", "Rescheduled to 2026-02-10"
  createdAt DateTime @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_activity_logs")
}

// ============================================
// LEADS (Contact Form & General Inquiries)
// ============================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

enum LeadSource {
  CONTACT_FORM
  WHATSAPP
  PHONE
  REFERRAL
  OTHER
}

model Lead {
  id        String     @id @default(uuid())
  name      String
  email     String?
  phone     String?
  source    LeadSource @default(CONTACT_FORM)
  subject   String?
  message   String?    @db.Text
  status    LeadStatus @default(NEW)
  notes     String?    @db.Text
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@map("leads")
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  phone     String   @unique
  address   String?  @db.Text
  notes     String?  @db.Text
  isVip     Boolean  @default(false) @map("is_vip")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  orders   Order[]
  bookings Booking[]

  @@map("customers")
}

// ============================================
// SERVICES (Offered Services)
// ============================================

// Service location types
enum ServiceLocation {
  WORKSHOP
  HOME
  BOTH
}

model Service {
  id          String          @id @default(cuid())
  title       String
  slug        String          @unique
  description String?         @db.Text
  price       Float           // Price in rupees
  duration    Int             // Duration in minutes
  location    ServiceLocation @default(BOTH) // Where service is provided
  features    String[]        @default([]) // What's included (e.g., warranty, parts)
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  images Image[] // Unified Image relation (supports multiple images)

  @@map("services")
}

// ============================================
// BOOKING SETTINGS (Scheduling configuration)
// ============================================

model BookingSettings {
  id                  Int      @id @default(1) // Single-row table
  slotDuration        Int      @default(60) // In minutes
  bufferTime          Int      @default(15) // In minutes between bookings
  advanceBookingDays  Int      @default(30) // How far in advance customers can book
  allowSameDayBooking Boolean  @default(true) // Can customers book same day?
  operatingHours      Json // Array of operating hours per day of week
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("booking_settings")
}

model BusinessSettings {
  id              String   @id @default("default") // Always "default" for single-row table
  businessName    String   @default("Shahzaib Autos") @map("business_name")
  bookingTimeSlots String[] @default(["9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"]) @map("booking_time_slots")
  maxBookingsPerSlot Int    @default(3) @map("max_bookings_per_slot")
  minAdvanceBookingDays Int @default(1) @map("min_advance_booking_days")
  maxAdvanceBookingDays Int @default(30) @map("max_advance_booking_days")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("business_settings")
}
